# Reverse proxy that serves both Web and API from a single host
# Cloudflare Tunnel should point its Service URL to http://dify-caddy:8080

:8080 {
  encode zstd gzip

  # Route API first (preserve full path)
  handle /console/api/* {
    reverse_proxy http://dify-api:5001 {
      header_up Host {host}
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-For {remote}
      header_up X-Real-IP {remote}
    }
  }

  # Everything else -> Web
  reverse_proxy http://dify-web:3000 {
    header_up Host {host}
    header_up X-Forwarded-Host {host}
    header_up X-Forwarded-Proto https
    header_up X-Forwarded-For {remote}
    header_up X-Real-IP {remote}
  }
}
